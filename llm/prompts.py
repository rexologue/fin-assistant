from typing import Any, List


PROMPT_NEWS_SELECTOR = (
    "Ты — интеллектуальный помощник по выбору финансовых новостей для пользователя.\n"
    "\n"
    "Тебе передан список новостей, предпочтения пользователя по расходам и список заголовков, "
    "которые ему ранее НЕ понравились.\n"
    "\n"
    "СПИСОК НОВОСТЕЙ (каждая новость уже пронумерована):\n"
    "{news_list}\n"
    "\n"
    "ТОП-5 НАПРАВЛЕНИЙ ТРАТ ПОЛЬЗОВАТЕЛЯ:\n"
    "{top_spend_categories}\n"
    "\n"
    "ЗАГОЛОВКИ НОВОСТЕЙ, КОТОРЫЕ ПОЛЬЗОВАТЕЛЮ НЕ ПОНРАВИЛИСЬ РАНЕЕ (МОЖЕТ БЫТЬ ПУСТО):\n"
    "{disliked_titles}\n"
    "\n"
    "Задача:\n"
    "1) Выбери только те новости, которые максимально релевантны интересам пользователя с учётом его направлений трат.\n"
    "2) Полностью игнорируй новости, чей заголовок ТОЧНО совпадает с любым заголовком из списка ранее не понравившихся.\n"
    "3) Если новости являются дубликатами (одинаковые или почти одинаковые по содержанию/заголовку), "
    "оставь только одну наиболее информативную, остальные не выводи.\n"
    "4) Ты можешь понимать новости на любых языках, но:\n"
    "   - НЕЛЬЗЯ менять текст source, title и content (нельзя переводить, сокращать, дополнять или исправлять).\n"
    "   - Используй их ровно в том виде, как они есть во входных данных.\n"
    "\n"
    "ВЫХОД:\n"
    "— Верни ТОЛЬКО выбранные новости в одном строковом ответе, БЕЗ любых комментариев, пояснений и лишних символов.\n"
    "— Каждую новость оформи строго так:\n"
    "  <src1>ТОЧНЫЙ source ПЕРВОЙ ВЫБРАННОЙ НОВОСТИ</src1>"
    "<title1>ТОЧНЫЙ title ПЕРВОЙ ВЫБРАННОЙ НОВОСТИ</title1>"
    "<content1>ТОЧНЫЙ content ПЕРВОЙ ВЫБРАННОЙ НОВОСТИ</content1>"
    "<src2>ТОЧНЫЙ source ВТОРОЙ ВЫБРАННОЙ НОВОСТИ</src2>"
    "<title2>ТОЧНЫЙ title ВТОРОЙ ВЫБРАННОЙ НОВОСТИ</title2>"
    "<content2>ТОЧНЫЙ content ВТОРОЙ ВЫБРАННОЙ НОВОСТИ</content2>"
    "...\n"
    "\n"
    "Жёсткие требования к формату:\n"
    "1) Нумерация тегов должна быть последовательной: 1, 2, 3, ...\n"
    "2) Для одной и той же новости номер в <srcN>, <titleN>, <contentN> ДОЛЖЕН совпадать.\n"
    "3) Не пропускай номера и не дублируй их.\n"
    "4) НЕ добавляй переносы строк или пробелы ВНЕ тегов. Ответ должен быть одной строкой, "
    "состоящей только из тегов <srcN>, <titleN>, <contentN> и их содержимого.\n"
    "5) Внутри тегов используй ровно тот текст source/title/content, который был во входе.\n"
    "\n"
    "Если ни одна новость не подходит под критерии, верни пустую строку (вообще никаких тегов).\n"
)


def build_news_inputs(
    news_list: str,
    top_spend_categories: List[str],
    disliked_titles: List[str],
    processor,
) -> dict[str, Any]:
    """
    news_list — готовая строка с блоками новостей:
        [НОВОСТЬ 1]
        source: ...
        title: ...
        content: ...
        ...
    top_spend_categories — список направлений трат (например: ['путешествия', 'онлайн-подписки', ...])
    disliked_titles — список заголовков, которые юзер уже дизлайкнул
    """

    top_spend_str = ", ".join(top_spend_categories) if top_spend_categories else "нет данных"
    disliked_str = "\n".join(disliked_titles) if disliked_titles else "нет"

    prompt_text = PROMPT_NEWS_SELECTOR.format(
        news_list=news_list,
        top_spend_categories=top_spend_str,
        disliked_titles=disliked_str,
    )

    messages = [{
        "role": "user",
        "content": [
            {"type": "text", "text": prompt_text},
        ],
    }]

    prompt = processor.apply_chat_template(
        messages,
        tokenize=False,
        add_generation_prompt=True,
    )

    inputs: dict[str, Any] = {
        "prompt": prompt,
        "multi_modal_data": {},
        "mm_processor_kwargs": {"use_audio_in_video": False},
    }

    return inputs
